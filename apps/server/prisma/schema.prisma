generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String @id @default(uuid())
  email        String @unique
  passwordHash String
  name         String
  role         String // "SUPER_ADMIN", "GROUP_ADMIN", "MEMBER"
  isActive     Boolean @default(true)
  
  groupId      String?
  group        Group? @relation(fields: [groupId], references: [id])
  
  // Status tracking for P0 features
  status       String @default("OFFLINE") // ACTIVE, AFK, DND, OFFLINE
  lastSeenAt   DateTime @default(now())
  
  createdInvites  Invite[]
  auditLogs       AuditLog[]
  refreshTokens   RefreshToken[]
  sentMessages    VoiceMessage[] @relation("SentMessages")
}

model Group {
  id            String @id @default(uuid())
  name          String
  maxSeats      Int @default(10)
  users         User[]
  invites       Invite[]
  voiceMessages VoiceMessage[]
}

model Invite {
  token     String @id
  email     String
  role      String
  groupId   String
  expiresAt DateTime
  
  createdBy String 
  creator   User @relation(fields: [createdBy], references: [id])
  
  group     Group @relation(fields: [groupId], references: [id])
}

model RefreshToken {
  token     String   @id
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
}

model AuditLog {
  id        String   @id @default(uuid())
  actorId   String
  actor     User     @relation(fields: [actorId], references: [id])
  action    String
  resource  String
  timestamp DateTime @default(now())
}

model VoiceMessage {
  id          String   @id @default(uuid())
  senderId    String
  sender      User     @relation("SentMessages", fields: [senderId], references: [id])
  
  // Recipients - either direct or group
  recipientId String?  // For 1-on-1 messages
  groupId     String?  // For group broadcasts
  group       Group?   @relation(fields: [groupId], references: [id])
  
  // Audio data
  audioUrl    String   // Supabase Storage URL
  duration    Int      // Duration in seconds
  
  // Metadata
  isPlayed    Boolean  @default(false)
  createdAt   DateTime @default(now())
  expiresAt   DateTime // Auto-delete after 7 days
  
  @@index([recipientId, createdAt])
  @@index([groupId, createdAt])
}
